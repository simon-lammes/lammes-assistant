<ion-header>
  <ion-toolbar>
    <ion-title>Save Exercise</ion-title>
    <ion-buttons slot="start">
      <ion-button (click)="dismissModal()">Close</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Segments-->
  <ion-segment mode="md" [value]="'edit'" (ionChange)="onSegmentChange($event)">
    <ion-segment-button value="edit">
      <ion-label>Edit</ion-label>
    </ion-segment-button>
    <ion-segment-button value="preview">
      <ion-label>Preview</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Edit View -->
  <ng-container *ngIf="selectedSegment === 'edit'">
    <form *ngIf="exerciseForm" [formGroup]="exerciseForm" (ngSubmit)="saveExercise()">
      <!-- Iterate over all exercise controls and only display them if they are part of the form
      This logic is necessary because different exercises require different fields. -->
      <ng-container *ngFor="let exerciseControl of allExerciseControls">
        <ng-container *ngIf="exerciseForm.contains(exerciseControl.controlName)">
          <ng-container [ngSwitch]="exerciseControl.type">
            <!-- Textarea -->
            <ion-item *ngSwitchCase="'textarea'">
              <ion-label>{{exerciseControl.title}}</ion-label>
              <ion-textarea rows="4" [formControlName]="exerciseControl.controlName"></ion-textarea>
            </ion-item>
            <!-- Text -->
            <ion-item *ngSwitchCase="'text'">
              <ion-label>{{exerciseControl.title}}</ion-label>
              <ion-input type="text" [formControlName]="exerciseControl.controlName" (ionBlur)="trim(exerciseForm.controls[exerciseControl.controlName])"></ion-input>
            </ion-item>
            <!-- Select -->
            <ion-item *ngSwitchCase="'select'">
              <ion-label>{{exerciseControl.title}}</ion-label>
              <ion-select interface="popover" [formControlName]="exerciseControl.controlName">
                <ion-select-option *ngFor="let selectOption of exerciseControl.selectOptions" [value]="selectOption.value">
                  {{selectOption.displayValue}}
                </ion-select-option>
              </ion-select>
            </ion-item>
            <!-- Checkbox -->
            <ion-item *ngSwitchCase="'checkbox'">
              <ion-label>{{exerciseControl.title}}</ion-label>
              <ion-checkbox slot="end" [formControlName]="exerciseControl.controlName"></ion-checkbox>
            </ion-item>
            <!-- Possible Answers -->
            <ion-list *ngSwitchCase="'possibleAnswers'" formArrayName="possibleAnswers">
              <ion-list-header>
                <ion-label>{{exerciseControl.title}}</ion-label>
              </ion-list-header>
              <ion-item-sliding [formGroup]="answerControl" *ngFor="let answerControl of getArrayControls('possibleAnswers'); let i = index">
                <ion-item >
                  <ion-input type="text" formControlName="value"></ion-input>
                  <ion-checkbox slot="end" formControlName="correct"></ion-checkbox>
                </ion-item>
                <ion-item-options side="end" (ionSwipe)="removeFile(i)">
                  <ion-item-option expandable="true" color="danger" (click)="removeFile(i)">
                    <ion-icon name="trash-outline"></ion-icon>
                    Remove
                  </ion-item-option>
                </ion-item-options>
              </ion-item-sliding>
              <ion-button type="button" (click)="addAnswer()">Add Answer</ion-button>
            </ion-list>
            <!-- Files -->
            <ion-list *ngSwitchCase="'files'">
              <ion-list-header>
                <ion-label>{{exerciseControl.title}}</ion-label>
              </ion-list-header>
              <ion-item-sliding *ngFor="let fileControl of getArrayControls('files'); let i = index">
                <!-- Actual item -->
                <ion-item >
                  <ion-label>{{fileControl.value.name}}</ion-label>
                  <ion-button slot="end" fill="clear" (click)="copyFileReferenceToClipboard(fileControl.value)">
                    <ion-icon name="clipboard-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                </ion-item>

                <!-- Sliding options right side -->
                <ion-item-options side="end" (ionSwipe)="removeFile(i)">
                  <ion-item-option expandable="true" color="danger" (click)="removeFile(i)">
                    <ion-icon name="trash-outline"></ion-icon>
                    Remove
                  </ion-item-option>
                </ion-item-options>
              </ion-item-sliding>
              <ion-button type="button" ngxFilePicker (filePick)="addFile($event)">Add File</ion-button>
            </ion-list>
          </ng-container>
        </ng-container>
      </ng-container>
      <ion-button type="submit" [disabled]="!exerciseForm.valid" expand="block">
        Save Changes
      </ion-button>
    </form>
  </ng-container>
  <!--  Preview-->
  <ng-container *ngIf="selectedSegment === 'preview'">
    <ng-container [ngSwitch]="exerciseForm.value.exerciseType">
      <app-multiselect-exercise *ngSwitchCase="'multiselect'" [exercise]="exerciseForm.value"></app-multiselect-exercise>
      <app-true-or-false-exercise *ngSwitchCase="'trueOrFalse'" [exercise]="exerciseForm.value"></app-true-or-false-exercise>
      <app-standard-exercise *ngSwitchDefault [exercise]="exerciseForm.value"></app-standard-exercise>
    </ng-container>
  </ng-container>
</ion-content>
